x-environment:
  &default-env
  SERVER_NAME: "Era of Blocks"
  ALLOW_FLIGHT: "TRUE"
  ENABLE_ROLLING_LOGS: "TRUE"
  TZ: "MSK"
  INIT_MEMORY: "4G"
  MEMORY: "8G"
  EULA: "TRUE"
  TYPE: "FABRIC"
  VERSION: "1.21.4"
  MODS_FILE: /third_party/mods.txt
  GUI: "FALSE"
  USE_SIMD_FLAGS: "TRUE"
  PLAYER_IDLE_TIMEOUT: "600"

networks:
  mc-network:
    driver: bridge    
    ipam:
      config:
        - subnet: 172.18.0.0/16

services:
  lazymc:
    image: ghcr.io/joesturge/lazymc-docker-proxy:latest
    networks:
      mc-network:
        ipv4_address: 172.18.0.2
    restart: unless-stopped
    volumes:
      - data:/server:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "25565:25565"

  mc:
    image: itzg/minecraft-server:java21-alpine
    networks:
      mc-network:
        ipv4_address: 172.18.0.3
    labels:
      - lazymc.enabled=true
      - lazymc.group=mc
      - lazymc.server.address=mc:25565
    tty: true
    stdin_open: true
    restart: no
    depends_on:
      - drasl
    environment:
      <<: *default-env
      JAVA_TOOL_OPTIONS: >-
        -Dminecraft.api.env=custom
        -Dminecraft.api.auth.host=http://172.18.0.4:25585/auth
        -Dminecraft.api.account.host=http://172.18.0.4:25585/account
        -Dminecraft.api.session.host=http://172.18.0.4:25585/session
        -Dminecraft.api.services.host=http://172.18.0.4:25585/services
    volumes:
      - data:/data
      - minecraft-world:/data/world
      - ./third_party:/third_party:ro

  drasl:
    image: unmojang/drasl
    networks:
      mc-network:
        ipv4_address: 172.18.0.4
    volumes:
      - drasl-data:/var/lib/drasl
      - ./drasl-config:/etc/drasl
    ports:
      - "25585:25585"

volumes:
  data:
  drasl-data:
  minecraft-world: